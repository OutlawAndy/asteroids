<!--
  /**
  * Copyright (c) 2014 Andy Cohen, https://github.com/OutlawAndy
  *
  * Permission is hereby granted, free of charge, to any person obtaining
  * a copy of this software and associated documentation files (the
  * "Software"), to deal in the Software without restriction, including
  * without limitation the rights to use, copy, modify, merge, publish,
  * distribute, sublicense, and/or sell copies of the Software, and to
  * permit persons to whom the Software is furnished to do so
  **/
-->

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale = 1" media="screen" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <title>astroids</title>
  <style>body{margin:0 !important;}</style>
</head>
<body>
  <img id="roid0" src="images/roid1.jpg" style="width:20px; height:20px; display:none" />
  <img id="roid1" src="images/roid2.jpg" style="width:20px; height:20px; display:none" />
  <img id="roid2" src="images/roid3.jpg" style="width:20px; height:20px; display:none" />
  <img id="roid2" src="images/roid4.jpg" style="width:20px; height:20px; display:none" />
  <img id="roid3" src="images/roid5.jpg" style="width:20px; height:20px; display:none" />
  <img id="roid4" src="images/roid6.jpg" style="width:20px; height:20px; display:none" />
  <img id="roid5" src="images/roid7.jpg" style="width:20px; height:20px; display:none" />
  <img id="roid6" src="images/roid8.jpg" style="width:20px; height:20px; display:none" />
  <img id="explosion" src="images/exploader.jpg" style="width:40px; height:40px; display:none" />
  <img id="spaceship" src="images/spaceship.png" style="width:50px; height:40px; display:none" />
  <audio id="lazer" src="audio/lazer.m4a" preload="auto"></audio>
  <audio id="exploder" src="audio/explosion.mp3" preload="auto"></audio>
  <audio id="soundtrack" src="audio/soundtrack.mp3" preload="auto" loop="true"></audio>

  <canvas id="game"></canvas>

  <script type="module">
    import * as Motion from "./modules/motion.js"
    import Sound from "./modules/Sound.js"
    import Explosion from "./modules/Explosion.js"
    import Clock from "./modules/Clock.js"
    import Photon from "./modules/Photon.js"
    import Spaceship from "./modules/Spaceship.js"

    const DEFAULT_ROCK_COUNT = 25
    var canvas, spaceship
    var GAME_MODE = 'ready'
    const sounds = [], rocks = [], photons = [], explosions = []
    const stats = {
      shots: 0,
      kills: 0,
      reset: function() {
        this.shots = 0
        this.kills = 0
      }
    }
    const gameClock = new Clock()
    const soundTrack = new Sound('soundtrack')

// <!-- ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ -->
// <!--------------------------------------------  Asteroid Class  -->

    function Asteroid(num) {
      this.image = document.getElementById('roid' + num)
      this.origin = { x: -10, y: -10 }
      this.size = { width: 20, height: 20 }
      this.x = Math.random() * canvas.width
      this.y = Math.random() * canvas.height
      this.heading = Math.random() * 360
      this.tilt = 0
      this.speed = Math.random() * 60
      this.rpm = Math.random() * 60 - 30
      this.wrap = true
      this.drift = Motion.drift(this)
      this.rotate = Motion.rotate(this)
      this.isHitBy = (x,y) => {
        var xDistance = Math.abs(x - this.x)
        var yDistance = Math.abs(y - this.y)
        return ((xDistance < this.size.width + 3) && (yDistance < this.size.height + 3))
      }
      this.paint = ctx => {
        this.drift()
        this.rotate()
        ctx.translate(this.x, this.y)
        ctx.rotate(this.tilt * Math.PI / 180)
        ctx.drawImage(this.image, this.origin.x, this.origin.y, this.size.width, this.size.height)
      }
    }

// <!-- ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ -->
// <!------------------------------------------------  User Input  -->

    const perform = event => {
      event.preventDefault()
      const {key, target} = event
      /* keyboard or on-screen button, like: <div data-action="shoot">Fire!</div> */
      const action = key ? keyMap[GAME_MODE][key] : target.dataset.action

      switch (action) {
        case 'start': newGame();              break
        case 'quit' : endGame();              break
        case 'shoot': spaceship.shoot();      break
        case 'right': spaceship.veerRight();  break
        case 'left' : spaceship.veerLeft();   break
        case 'accel': spaceship.accelerate(); break
        case 'decel': spaceship.decelerate(); break
        case 'music': soundTrack.toggle();    break
        case 'help' :/*add modal help page*/; break
      }
    }

    const keyMap = {
      ready: {
        'Enter'       : 'start',
        '/'           : 'help',
      },
      gameOver: {
        'Enter'       : 'start',
        '/'           : 'help',
      },
      gameOn: {
        ' '           : 'shoot',
        'f'           : 'shoot',
        'ArrowLeft'   : 'left',
        'h'           : 'left',
        'ArrowUp'     : 'accel',
        'j'           : 'accel',
        'ArrowDown'   : 'decel',
        'k'           : 'decel',
        'ArrowRight'  : 'right',
        'l'           : 'right',
        'q'           : 'quit',
        'm'           : 'music',
        '/'           : 'help',
      },
    }

// <!-- ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ -->
// <!-------------------------------------------------  Utilities  -->

    const rockCount = () => {
      const params = new URLSearchParams(window.location.search)
      if (params.has('rocks')) {
        return parseInt(params.get('rocks'));
      } else {
        return DEFAULT_ROCK_COUNT;
      }
    }

    const playSounds = () => {
      if (sounds.length === 0) return

      sounds.forEach((sound, index) => {
        sound.play()
        sounds.splice(index, 1)
      })
    }

    const paintClock = ctx => {
      ctx.fillStyle = "green"
      ctx.font = "italic 16pt Arial"
      ctx.textAlign = "left"
      ctx.fillText("elapsed: " + gameClock.read(), 10, 20)
      ctx.restore()
    }

    const paintSpace = ctx => {
      ctx.fillStyle = "black"
      ctx.fillRect(0, 0, canvas.width, canvas.height)
      ctx.save()
    }

    const detectHits = () => {
      photons.forEach(photon => {
        rocks.forEach(rock => {
          if (rock.isHitBy(photon.x, photon.y)) {
            stats.kills++
            photon.gone = true
            rock.gone = true
            explosions.push(new Explosion(rock.x, rock.y, photon.heading))
            sounds.push(new Sound('exploder'))
          }
        })
      })
    }

    const handleFire = event => {
      const {x, y, heading} = event.detail
      photons.push(new Photon(x, y, heading))
      sounds.push(new Sound('lazer'))
      stats.shots++
    }

// <!-- ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ -->
// <!---------------------------------------------  Title Screens  -->

    const postGame = ctx => {
      let startX, endX, font
      if (canvas.width > 1080) {
        font = "bold 72pt Arial";
        startX = 2*(canvas.width/5);
        endX = 3*(canvas.width/5);
      } else {
        font = "bold 52pt Arial";
        startX = 2*(canvas.width/6);
        endX = 4*(canvas.width/6);
      }
      ctx.restore();
      ctx.fillStyle = "white";
      ctx.textAlign = "center"
      ctx.font = font;
      ctx.fillText("GAME OVER", canvas.width/2, canvas.height/2);
      ctx.font = "normal 16pt Arial";
      ctx.textAlign = "left";
      ctx.fillText("Time: ",        startX, canvas.height/2 + 30);
      ctx.fillText("Shots Fired: ", startX, canvas.height/2 + 60);
      ctx.fillText("Space Rocks: ", startX, canvas.height/2 + 90);
      ctx.textAlign = "right";
      ctx.fillText( gameClock.read(), endX, canvas.height/2 + 30);
      ctx.fillText( stats.shots,     endX, canvas.height/2 + 60);
      ctx.fillText( stats.kills,     endX, canvas.height/2 + 90);
      ctx.textAlign = "center"
      ctx.font = "italic 24pt Arial";
      ctx.fillStyle = "rgba(200,200,200,0.2)";
      ctx.fillText( "Press Enter To Play Again", canvas.width/2, canvas.height/2 + 140);
    }

    const preGame = ctx => {
      let startX, endX, font
      if (canvas.width > 1080) {
        font = "italic 48pt Arial";
        startX = 2*(canvas.width/5);
        endX = 3*(canvas.width/5);
      } else {
        font = "italic 36pt Arial";
        startX = 2*(canvas.width/6);
        endX = 4*(canvas.width/6);
      }
      ctx.textAlign = "center";
      ctx.font = font;
      ctx.fillStyle = "rgba(200,200,200,0.2)";
      ctx.fillText( "Press Enter To Play", canvas.width/2, canvas.height/2);
      ctx.font = "normal 16pt Arial";
      ctx.textAlign = "left";
      ctx.fillText("Shoot: ",     startX, canvas.height/2 + 30 );
      ctx.fillText("Go: ",        startX, canvas.height/2 + 60);
      ctx.fillText("Turn: ",      startX, canvas.height/2 + 90);
      ctx.textAlign = "right";
      ctx.fillText( "SpaceBar",   endX, canvas.height/2 + 30 );
      ctx.fillText( "Up/Down",    endX, canvas.height/2 + 60);
      ctx.fillText( "Left/Right", endX, canvas.height/2 + 90);
    }

// <!-- ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ -->
// <!--------------------------------------------------  Run Loop  -->

    const main = ctx => {
      requestAnimationFrame(() => main(ctx))
      paintSpace(ctx)
      play[GAME_MODE](ctx)
    }

    const game = ctx => {
      if (rocks.length === 0) endGame()
      spaceship.paint(ctx)
      ctx.restore()

      paintClock(ctx)
      detectHits()
      playSounds()
      paintAll(ctx, rocks)
      paintAll(ctx, photons)
      paintAll(ctx, explosions)
    }

    const paintAll = (ctx, actors) => {
      actors.forEach((actor, index) => {
        ctx.save()
        actor.paint(ctx)
        ctx.restore()
        if (actor.gone) actors.splice(index, 1)
      })
    }

// <!-- ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ -->
// <!---------------------------------  gameSetup & State Transitions  -->

    const gameSetup = () => {
      spaceship = new Spaceship(canvas.width/2, canvas.height/2, 0) /* centered */

      sounds.push(soundTrack)
      stats.reset()
      gameClock.restart()

      Array.from({length: rockCount()}, (_, index) => {
        rocks[index] = new Asteroid(Math.floor(Math.random() * 7))
      })
    }

    const endGame = () => {
      GAME_MODE = 'gameOver'
      soundTrack.stop()
      gameClock.stop()
    }

    const newGame = () => {
      GAME_MODE = 'gameOn'
      gameSetup()
    }

    // Game Modes / Action Functions
    const play = {
      'ready'   : preGame,
      'gameOn'  : game,
      'gameOver': postGame
    }

    const init = () => {
      canvas = document.getElementById("game")
      canvas.width = window.innerWidth
      canvas.height = window.innerHeight

      gameSetup()
      requestAnimationFrame(() => main(canvas.getContext('2d')))
    }

// <!-- ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ -->
// <!------------------------------------  Event Listeners  -->

    window.addEventListener('load', init, true);
    window.addEventListener('keydown', perform, true);
    window.addEventListener('click', perform, true);
    window.addEventListener('Spaceship:fire!', handleFire, true);
  </script>
</body>
</html>
